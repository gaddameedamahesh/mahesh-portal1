pipeline {
    agent any

    environment {
        MAVEN_HOME = tool name: 'maven3', type: 'maven'
        JAVA_HOME  = tool name: 'java17', type: 'jdk'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/gaddameedamahesh/mahesh-portal1.git',
                    credentialsId: 'github-creds' // Replace with your GitHub credential ID in Jenkins
            }
        }

        stage('Build') {
            steps {
                withEnv(["PATH+MAVEN=${MAVEN_HOME}/bin","JAVA_HOME=${JAVA_HOME}"]) {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonarqube') { // Use your SonarQube installation name in Jenkins
                    sh "${MAVEN_HOME}/bin/mvn sonar:sonar -Dsonar.login=${SONAR_TOKEN}" // SONAR_TOKEN is your Jenkins Secret Text
                }
            }
        }

        stage('Upload to Nexus') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'nexus-creds', usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')]) {
                    sh """${MAVEN_HOME}/bin/mvn deploy:deploy-file \
                        -DrepositoryId=mahesh-nexus \
                        -Durl=http://18.212.239.48:8081/repository/mahesh-portal1/ \
                        -Dfile=target/mahesh-portal.war \
                        -DgroupId=devops \
                        -DartifactId=mahesh-portal \
                        -Dversion=1.0-SNAPSHOT \
                        -Dpackaging=war \
                        -Dusername=$NEXUS_USER \
                        -Dpassword=$NEXUS_PASS"""
                }
            }
        }

        stage('Deploy to Tomcat') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'tomcat-creds', usernameVariable: 'TOMCAT_USER', passwordVariable: 'TOMCAT_PASS')]) {
                    sh """curl -u $TOMCAT_USER:$TOMCAT_PASS \
                        -T target/mahesh-portal.war \
                        http://18.212.184.15:8080/manager/text/deploy?path=/mahesh-portal&update=true"""
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment successful!'
        }
        failure {
            echo 'Build failed. Check the logs!'
        }
    }
}

