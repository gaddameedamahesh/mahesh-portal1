pipeline {
    agent any

    // Tools configuration
    tools {
        maven 'maven3'   // Ensure this matches the name in Jenkins Global Tool Config
        jdk 'java17'     // Ensure this matches the name in Jenkins Global Tool Config
    }

    environment {
        // GitHub repository credentials
        GIT_CREDENTIALS = 'github-creds'

        // Nexus credentials
        NEXUS_CREDENTIALS = 'nexus-creds'
        NEXUS_URL = 'http://18.212.239.48:8081/repository/mahesh-portal1/'

        // Tomcat credentials
        TOMCAT_CREDENTIALS = 'tomcat-creds'
        TOMCAT_URL = 'http://18.212.184.15:8080/'

        // SonarQube installation name
        SONARQUBE = 'sonarqube'
    }

    stages {

        stage('Checkout') {
            steps {
                git url: 'https://github.com/gaddameedamahesh/mahesh-portal1.git', credentialsId: "${GIT_CREDENTIALS}"
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONARQUBE}") {
                    sh 'mvn sonar:sonar'
                }
            }
        }

        stage('Upload to Nexus') {
            steps {
                nexusArtifactUploader(
                    nexusVersion: 'nexus3',
                    protocol: 'http',
                    nexusUrl: '18.212.239.48:8081',
                    repository: 'mahesh-portal1',
                    credentialsId: "${NEXUS_CREDENTIALS}",
                    groupId: 'devops',
                    artifactId: 'mahesh-portal',
                    version: '1.0-SNAPSHOT',
                    packaging: 'war',
                    file: 'target/mahesh-portal.war'
                )
            }
        }

        stage('Deploy to Tomcat') {
            steps {
                tomcatDeploy(
                    url: "${TOMCAT_URL}",
                    credentialsId: "${TOMCAT_CREDENTIALS}",
                    war: 'target/mahesh-portal.war',
                    path: 'mahesh-portal'
                )
            }
        }
    }

    post {
        always {
            echo 'Build finished!'
        }
        success {
            echo 'Deployment completed successfully!'
        }
        failure {
            echo 'Build failed. Check the logs for details.'
        }
    }
}

