pipeline {
    agent any

    environment {
        MAVEN_HOME = tool name: 'maven3', type: 'maven'       // Jenkins global Maven tool name
        JAVA_HOME  = tool name: 'java17', type: 'jdk'         // Jenkins global JDK 17 tool name
        NEXUS_URL  = 'http://18.212.239.48:8081/repository/mahesh-portal1/'
        TOMCAT_URL = 'http://18.212.184.15:8080/manager/text'
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/gaddameedamahesh/mahesh-portal1.git',
                    credentialsId: 'github-credentials-id'   // Add GitHub credentials in Jenkins
            }
        }

        stage('Build') {
            steps {
                withEnv(["PATH+MAVEN=${MAVEN_HOME}/bin","JAVA_HOME=${JAVA_HOME}"]) {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonarqube') {  // SonarQube server name in Jenkins
                    sh "${MAVEN_HOME}/bin/mvn sonar:sonar"
                }
            }
        }

        stage('Upload to Nexus') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'nexus-credentials-id', usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')]) {
                    sh """
                        mvn deploy:deploy-file \
                        -Durl=${NEXUS_URL} \
                        -DrepositoryId=nexus-repo \
                        -Dfile=target/mahesh-portal.war \
                        -DgroupId=devops \
                        -DartifactId=mahesh-portal \
                        -Dversion=1.0-SNAPSHOT \
                        -Dpackaging=war \
                        -DgeneratePom=true \
                        -Dusername=$NEXUS_USER \
                        -Dpassword=$NEXUS_PASS
                    """
                }
            }
        }

        stage('Deploy to Tomcat') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'tomcat-credentials-id', usernameVariable: 'TOMCAT_USER', passwordVariable: 'TOMCAT_PASS')]) {
                    sh """
                        curl -u $TOMCAT_USER:$TOMCAT_PASS \
                        -T target/mahesh-portal.war \
                        "${TOMCAT_URL}/deploy?path=/mahesh-portal&update=true"
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Build, SonarQube, Nexus, and Tomcat deployment completed successfully!'
        }
        failure {
            echo 'Build failed. Check the logs for details.'
        }
    }
}

