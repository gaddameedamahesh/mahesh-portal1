pipeline {
    agent any

    tools {
        jdk 'java17'       // Make sure this matches the JDK configured in Jenkins
        maven 'maven3'     // Make sure this matches Maven installation in Jenkins
    }

    environment {
        // Nexus credentials stored in Jenkins Credentials (Username with password)
        NEXUS_CREDENTIALS = credentials('nexus-creds')
        // GitHub credentials stored in Jenkins (PAT)
        GIT_CREDENTIALS = 'maheshprojects-creds'
        // Nexus repository URL
        NEXUS_URL = 'http://18.212.239.48:8081/repository/mahesh-portal1/'
        // Tomcat info
        TOMCAT_URL = 'http://your-tomcat-server:8080/manager/text'
        TOMCAT_USER = credentials('tomcat-creds')  // Tomcat username/password in Jenkins
    }

    stages {

        stage('Checkout SCM') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/gaddameedamahesh/mahesh-portal1.git',
                    credentialsId: "${GIT_CREDENTIALS}"
            }
        }

        stage('Build with Maven') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('Upload to Nexus') {
            steps {
                sh """
                mvn deploy:deploy-file \
                    -DgroupId=devops \
                    -DartifactId=mahesh-portal \
                    -Dversion=1.0-SNAPSHOT \
                    -Dpackaging=war \
                    -Dfile=target/mahesh-portal.war \
                    -DrepositoryId=nexus \
                    -Durl=${NEXUS_URL} \
                    -Dusername=${NEXUS_CREDENTIALS_USR} \
                    -Dpassword=${NEXUS_CREDENTIALS_PSW}
                """
            }
        }

        stage('Deploy to Tomcat') {
            steps {
                sh """
                curl --upload-file target/mahesh-portal.war \
                     --user ${TOMCAT_USER_USR}:${TOMCAT_USER_PSW} \
                     "${TOMCAT_URL}/deploy?path=/mahesh-portal&update=true"
                """
            }
        }
    }

    post {
        success {
            echo "Build and Deployment Successful!"
        }
        failure {
            echo "Build or Deployment Failed. Check logs!"
        }
    }
}

